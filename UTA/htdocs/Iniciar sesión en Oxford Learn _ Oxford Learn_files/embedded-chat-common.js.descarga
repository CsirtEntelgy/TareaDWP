(function(e,f){var d=e.EmbeddedChat=e.EmbeddedChat||{};e.CONFIG={MAX_CHAT_MSG_LENGTH:5000};_.templateSettings={interpolate:/\{\{(.+?)\}\}/g,escape:/\{\{\{(.+?)\}\}\}/g};d.getCombinedHeight=_.partial(_.reduce,_,function(b,a){return b+f(a).outerHeight(true)},0);d.validateFieldLength=function(){var b=f(this),a=b.val(),c=b.attr("maxlength");if(a.length>c){b.val(a.substr(0,c))}};d.isPopup=function(){return false};d.doVerticalResize=function(n,l){var m=n.closest(".inner-container");var a=n.closest(".main");var p=a.siblings(".header,.footer,.error-server-unavailable:visible,acknowledge-text:visible");var o=this.getCombinedHeight(p);var c=this.getCombinedHeight(l);a.height(m.height()-o);if(l){var b=n.outerHeight(true)-n.height();n.height(a.height()-c-b)}};d.getDefaultWindowSize=function(){return{width:parseInt(this.windowProperties.width,10),height:parseInt(this.windowProperties.height.open,10)}};d.getWindowChromeSize=function(){return{width:window.outerWidth-window.innerWidth,height:window.outerHeight-window.innerHeight}};d.getWindowInnerSize=function(){return{width:window.innerWidth,height:window.innerHeight}};d.resizeWindow=function(a,n){if(n&&this.windowProperties){var q=this.getDefaultWindowSize();var c=a.prop("scrollHeight")-a.height();var p=10;this.customWidth=q.width;this.customHeight=q.height+c+p;if(this.isPopup()){var b=this.getWindowChromeSize();var r=this.customWidth+b.width;var o=this.customHeight+b.height;window.resizeTo(r,o);window.setTimeout(_.bind(function(){var h=this.getWindowInnerSize();var g=this.customHeight-h.height;if(g>0){window.moveBy(0,-g);window.resizeTo(r,o)}window.setTimeout(_.bind(function(){this.customWidth=h.width;this.customHeight=h.height},this),0)},this),0)}else{var m=this.chatBrowserInfo.innerHeight;this.customHeight=this.customHeight>m?m:this.customHeight;this.sendMessage("chat:resize",{width:this.customWidth+"px",height:this.customHeight+"px"})}}};d.restorePopupSize=function(){var b=this.getDefaultWindowSize();var a=this.getWindowChromeSize();this.customWidth=b.width;this.customHeight=b.height;window.resizeTo(this.customWidth+a.width,this.customHeight+a.height)};d.canResize=function(b){var a=this.customWidth===undefined||this.customWidth==window.innerWidth;var c=this.customHeight===undefined||this.customHeight==window.innerHeight;return b&&(this.isPopup()?a&&c:true)};d.recalculateHeight=function(c){var i=f(".js-form-list:visible"),j=f(".js-message-history:visible"),a=f(".confirm-close:visible"),b=f(".js-translation-header:visible");if(i.length){this.resizeWindow(i,this.canResize(c));this.doVerticalResize(i,i.siblings("button"))}if(j.length){if(this.isPopup()&&this.canResize(c)){this.restorePopupSize()}if(b.length){this.doVerticalResize(j,j.siblings(".message-box, .translation-header"))}else{this.doVerticalResize(j,j.siblings(".message-box"))}}if(a.length){this.doVerticalResize(a)}};d.resetScroll=function(){f(".js-form-list").animate({scrollTop:0},"fast")};d.showHideChatMenu=function(c,a,b){b.preventDefault&&b.preventDefault();var h=Math.floor(c.position().top)===0;c.animate({top:h?-(a.height()+1)+"px":0},300,"swing",function(){var g=c.position()&&Math.floor(c.position().top);h=g===0||g===-1;if(!h){a.css("visibility","hidden")}else{a.find(".action").first().focus()}});a.css("visibility","initial");if(d.i18n){b.target.setAttribute("title",h?d.i18n.t("pullDownInfo"):d.i18n.t("pullUpInfo"));b.target.setAttribute("aria-label",h?d.i18n.t("pullDownInfo"):d.i18n.t("pullUpInfo"))}};d.setupChatWindow=function(){var c=f(".js-message-actions");var a=c.find(".actions");var j=c.find(".js-flag");c.css("top",-(a.height()+1)+"px");a.css("visibility","hidden");j.click(this.showHideChatMenu.bind(this,c,a));var b=f("#message-counter");if(b.length){b.html(CONFIG.MAX_CHAT_MSG_LENGTH);var i=f("#message-field");i.on("keyup",function(m){var h=CONFIG.MAX_CHAT_MSG_LENGTH;var n=i.val().length;var g=h-n;b.toggleClass("counter-limit",g<1);b.html(g)})}};d.modernize=function(b){var a=b?f(b):f("body");if(!("maxLength" in document.createElement("textarea"))){a.find("textarea[maxlength]").on("keydown keyup focus blur",this.validateFieldLength)}}})(this,jQuery);